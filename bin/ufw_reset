#!/bin/bash

# cat /etc/services

# ufw default deny outgoing

# ufw allow out to 192.168.5.1 port 8080
# ufw allow out to 192.168.5.1 port domain
# ufw allow out to 10.76.122.0/24 port imaps
# ufw allow out to 255.255.255.255 port 17500 # dropbox
# ufw allow out http
# ufw allow out https
# ufw allow out ssh
# ufw allow out to 192.168.5.1 port domain
# ufw allow out to 10.76.122.21 port domain
# ufw allow out to 10.76.122.21 port imaps
# ufw allow out to 10.76.122.150 port imaps
# ufw allow out to 157.56.252.166 port imaps

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
outlook_com_ips=`sed '/^\#/d' "${DIR}/outlook.com.ips"`
# outlook_com_ips=`host -t MX outlook.com | grep -v alias | rev | cut -d ' '  -f 1 | rev`
gmail_com_ips=`host smtp.gmail.com | grep -v alias | rev | cut -d ' '  -f 1 | rev`

# Reset all ufw rules
yes | ufw reset

# Deny all incoming
# Accept all outgoing accept for controlable ports (dns, imap, pop3, etc. )

# DEFAULT
ufw default allow outgoing
ufw default deny incoming

# DNS
ufw allow out to 10.76.122.21 port domain
ufw allow out to 192.168.1.1 port domain
ufw allow out to 192.168.5.1 port domain
ufw allow out to 192.168.5.200 port domain # VPN
ufw allow out to 1208.67.222.222 port domain # OpenDNS
ufw allow out to 1208.67.220.220 port domain # OpenDNS
ufw deny out to any port domain

# SMTP
# ufw allow out to 10.76.122.150 port smtp
# for ip in $outlook_com_ips; do
    # ufw allow out to $ip port smtp; # outlook.com
# done;
ufw deny out to any port smtp

# SMTP submission + SMTPS
for protocol in smtps submission; do
    ufw allow out to 10.76.122.150 port $protocol
    for ip in $outlook_com_ips; do
        ufw allow out to $ip port $protocol; # outlook.com
    done;
    for ip in $gmail_com_ips; do
        ufw allow out to $ip port $protocol; # gmail.com
    done;
    ufw deny out to any port $protocol
done;

# IMAP
ufw deny out to any port imap

# POP3
ufw deny out to any port pop3

# IMAPS
ufw allow out to 10.76.122.150 port imaps
for ip in $outlook_com_ips; do
    ufw allow out to $ip port imaps; # outlook.com
done;
ufw deny out to any port imaps

# IRC
ufw allow out to 192.168.5.0/24 port irc
ufw deny out to any port irc

# PUPPET
ufw allow out to 192.168.5.0/24 port 8140
ufw deny out to any port 8140

# BACULA
ufw allow in from 192.168.5.0/24 to any port bacula-fd
ufw allow out to 192.168.5.0/24 port bacula-dir
ufw allow out to 192.168.5.0/24 port bacula-sd

ufw enable
